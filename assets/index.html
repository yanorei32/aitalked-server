<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset=UTF-8>
	<meta name=viewport content="width=device-width,initial-scale=1">
	<title>Aitalked Server</title>
	<style>
		html, body {
			width: 100%;
			margin: 0;
			padding: 0;
			border: 0;
		}
		.container {
			max-width: 800px;
			margin: auto;
		}
		#text {
			width: 100%;
			height: 10em;
		}
	</style>
</head>
<body>
	<div class=container>
		<h1>Aitalked Server</h1>

		<p>
			<img id=character_icon width=48 height=48>
			<select id=character_selector></select>
			(<span id=character_count>0</span> characters available.)
		</p>
		<table>
			<tr>
				<td><label for=is_kansai>IsKansai?</label></td>
				<td><input type=checkbox id=is_kansai></td>
			</tr>
			<tr>
				<td><label for=volume>Volume</label></td>
				<td><input type=range id=volume value=1.0 min=0.0 max=5.0 step=0.01></td>
				<td><span id=volume_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=speed>Speed</label></td>
				<td><input type=range id=speed value=1.0 min=0.5 max=4.0 step=0.01></td>
				<td><span id=speed_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=pitch>Pitch</label></td>
				<td><input type=range id=pitch value=1.0 min=0.5 max=2.0 step=0.01></td>
				<td><span id=pitch_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=range>Range</label></td>
				<td><input type=range id=range value=1.0 min=0.0 max=2.0 step=0.01></td>
				<td><span id=range_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=pause_middle>Pause Middle</label></td>
				<td><input type=range id=pause_middle value=150 min=80 max=500></td>
				<td><span id=pause_middle_s>150</span></td>
			</tr>
			<tr>
				<td><label for=pause_long>Pause Long</label></td>
				<td><input type=range id=pause_long value=370 min=100 max=2000></td>
				<td><span id=pause_long_s>370</span></td>
			</tr>
			<tr>
				<td><label for=pause_sentence>Pause Sentence</label></td>
				<td><input type=range id=pause_sentence value=800 min=200 max=10000></td>
				<td><span id=pause_sentence_s>800</span></td>
			</tr>
		</table>
		<p>Must be: Middle &lt;= Long &lt;= Sentence</p>

		<textarea id=text placeholder="Text to Synthesis"></textarea>
		<p>
			<button id=reset>Reset</button>
			<button id=synthesis_button>Synthesis</button>
		</p>
		<audio id=audio></audio>
		<script>
			let characters;
			const character_selector = document.getElementById("character_selector");
			const is_kansai = document.getElementById("is_kansai");
			const text = document.getElementById("text");
			const volume = document.getElementById("volume");
			const speed = document.getElementById("speed");
			const pitch = document.getElementById("pitch");
			const range = document.getElementById("range");
			const pause_middle = document.getElementById("pause_middle");
			const pause_long = document.getElementById("pause_long");
			const pause_sentence = document.getElementById("pause_sentence");

			const fmt_float = v => {
				v += "";

				const parts = v.split(".");

				if (parts.length == 1)
					parts.push("");

				while (parts[1].length < 2)
					parts[1] += "0";

				return parts.join(".");
			}

			const update_values = () => {
				document.getElementById("volume_s").textContent = fmt_float(volume.value);
				document.getElementById("speed_s").textContent = fmt_float(speed.value);
				document.getElementById("pitch_s").textContent = fmt_float(pitch.value);
				document.getElementById("range_s").textContent = fmt_float(range.value);
				document.getElementById("pause_middle_s").textContent = pause_middle.value;
				document.getElementById("pause_long_s").textContent = pause_long.value;
				document.getElementById("pause_sentence_s").textContent = pause_sentence.value;
			};

			update_values();

			document.getElementById("reset").addEventListener("click", () => {
				volume.value = 1.0;
				speed.value = 1.0;
				pitch.value = 1.0;
				range.value = 1.0;
				pause_middle.value = 150;
				pause_long.value = 370;
				pause_sentence.value = 800;
				update_values();
			});

			volume.addEventListener("change", update_values);
			speed.addEventListener("change", update_values);
			pitch.addEventListener("change", update_values);
			range.addEventListener("change", update_values);
			pause_middle.addEventListener("change", update_values);
			pause_long.addEventListener("change", update_values);
			pause_sentence.addEventListener("change", update_values);

			const update_character_icon = () => {
				const icon = characters.find(c => c.name == character_selector.value).icon;
				document.getElementById("character_icon").src = "data:image/png;base64," + icon;
			};

			const update_is_kansai = () => {
				is_kansai.checked = character_selector.value.includes("west");
			};

			character_selector.addEventListener("change", () => {
				update_character_icon();
				update_is_kansai();
			});

			fetch("/api/voices")
				.then(resp => resp.json())
				.then(characters_ => {
					characters = characters_;

					for (character of characters) {
						const option = document.createElement("option");
						option.textContent = character.name;
						option.value = character.name;
						character_selector.appendChild(option);
					}

					update_character_icon();
					update_is_kansai();
					document.getElementById("character_count").textContent = characters.length;
				});

			document.getElementById("synthesis_button").addEventListener("click", async () => {
				const request_body = JSON.stringify({
					voice_name: character_selector.value,
					is_kansai: is_kansai.checked,
					text: text.value,
					volume: volume.value - 0,
					speed: speed.value - 0,
					pitch: pitch.value - 0,
					range: range.value - 0,
					pause_middle: pause_middle.value - 0,
					pause_long: pause_long.value - 0,
					pause_sentence: pause_sentence.value - 0,
				});

				const audio_ctx = new AudioContext();
				const response = await fetch("/api/tts", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: request_body,
				});

				if (response.status != 200) {
					alert(response.status + " " + response.statusText + "\n" + await response.text());
					return;
				}

				const raw_wav = new Uint8Array(await response.arrayBuffer());

				const f32_buffer = new Float32Array(raw_wav.length / 2);

				for (let i = 0; i < f32_buffer.length; ++i) {
					let sample = (raw_wav[i * 2 + 1]  << 8) + raw_wav[i * 2];
					sample = sample >= 32768 ? sample - 65536 : sample;
					f32_buffer[i] = sample / 32768.0;
				}

				const audio_buffer = audio_ctx.createBuffer(1, f32_buffer.length, 44100);
				audio_buffer.copyToChannel(f32_buffer, 0)

				const source = audio_ctx.createBufferSource();
				source.buffer = audio_buffer;
				source.connect(audio_ctx.destination);
				source.start();
			});
		</script>
	</div>
</body>
</html>
