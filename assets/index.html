<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset=UTF-8>
	<meta name=viewport content="width=device-width,initial-scale=1">
	<title>Aitalked Server</title>
	<style>
		html, body {
			width: 100%;
			margin: 0;
			padding: 0;
			border: 0;
		}
		.container {
			max-width: 800px;
			margin: auto;
		}
		#text {
			width: calc(100% - 10px);
			height: 10em;
		}
		#character_color {
			width: 5px;
			height: 48px;
			display: inline-block;
		}
		#character_selection {
			margin: 5px 0;
		}
	</style>
</head>
<body>
	<div class=container>
		<h1>Aitalked Server</h1>

		<div id=character_selection>
			<div id=character_color></div><img id=character_icon width=48 height=48>
			<select id=character_selector></select>
			(<span id=character_count>0</span> characters available.)
		</div>
		<table>
			<tr>
				<td><label for=is_kansai>IsKansai?</label></td>
				<td><input type=checkbox id=is_kansai></td>
			</tr>
			<tr>
				<td><label for=volume>Volume</label></td>
				<td><input type=range id=volume value=1.0 min=0.0 max=5.0 step=0.01></td>
				<td><span id=volume_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=speed>Speed</label></td>
				<td><input type=range id=speed value=1.0 min=0.5 max=4.0 step=0.01></td>
				<td><span id=speed_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=pitch>Pitch</label></td>
				<td><input type=range id=pitch value=1.0 min=0.5 max=2.0 step=0.01></td>
				<td><span id=pitch_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=range>Range</label></td>
				<td><input type=range id=range value=1.0 min=0.0 max=2.0 step=0.01></td>
				<td><span id=range_s>1.00</span></td>
			</tr>
			<tr>
				<td><label for=pause_middle>Pause Middle</label></td>
				<td><input type=range id=pause_middle value=150 min=80 max=500></td>
				<td><span id=pause_middle_s>150</span></td>
			</tr>
			<tr>
				<td><label for=pause_long>Pause Long</label></td>
				<td><input type=range id=pause_long value=370 min=100 max=2000></td>
				<td><span id=pause_long_s>370</span></td>
			</tr>
			<tr>
				<td><label for=pause_sentence>Pause Sentence</label></td>
				<td><input type=range id=pause_sentence value=800 min=200 max=10000></td>
				<td><span id=pause_sentence_s>800</span></td>
			</tr>
			<tr>
				<td></td>
				<td><button id=reset>Reset Parameter</button></td>
			</tr>
		</table>

		<textarea id=text placeholder="Text to Synthesis"></textarea>
		<p>
			<button id=synthesis_button>Synthesis</button>
		</p>
		<audio id=audio controls></audio>
		<script>
			let characters;
			const character_selector = document.getElementById("character_selector");
			const is_kansai = document.getElementById("is_kansai");
			const text = document.getElementById("text");
			const volume = document.getElementById("volume");
			const speed = document.getElementById("speed");
			const pitch = document.getElementById("pitch");
			const range = document.getElementById("range");
			const pause_middle = document.getElementById("pause_middle");
			const pause_long = document.getElementById("pause_long");
			const pause_sentence = document.getElementById("pause_sentence");

			const fmt_float = v => {
				v += "";

				const parts = v.split(".");

				if (parts.length == 1)
					parts.push("");

				while (parts[1].length < 2)
					parts[1] += "0";

				return parts.join(".");
			}

			const update_values = () => {
				document.getElementById("volume_s").textContent = fmt_float(volume.value);
				document.getElementById("speed_s").textContent = fmt_float(speed.value);
				document.getElementById("pitch_s").textContent = fmt_float(pitch.value);
				document.getElementById("range_s").textContent = fmt_float(range.value);
				document.getElementById("pause_middle_s").textContent = pause_middle.value;
				document.getElementById("pause_long_s").textContent = pause_long.value;
				document.getElementById("pause_sentence_s").textContent = pause_sentence.value;
			};

			update_values();

			document.getElementById("reset").addEventListener("click", () => {
				volume.value = 1.0;
				speed.value = 1.0;
				pitch.value = 1.0;
				range.value = 1.0;
				pause_middle.value = 150;
				pause_long.value = 370;
				pause_sentence.value = 800;
				update_values();
			});

			volume.addEventListener("change", update_values);
			speed.addEventListener("change", update_values);
			pitch.addEventListener("change", update_values);
			range.addEventListener("change", update_values);
			pause_middle.addEventListener("change", () => {
				pause_long.value = Math.max(pause_long.value, pause_middle.value);
				pause_sentence.value = Math.max(pause_sentence.value, pause_middle.value);
				update_values();
			});
			pause_long.addEventListener("change", () => {
				pause_middle.value = Math.min(pause_middle.value, pause_long.value);
				pause_sentence.value = Math.max(pause_sentence.value, pause_long.value);
				update_values();
			});
			pause_sentence.addEventListener("change", () => {
				pause_middle.value = Math.min(pause_middle.value, pause_sentence.value);
				pause_long.value = Math.min(pause_long.value, pause_sentence.value);
				update_values();
			});

			const update_character = () => {
				const character = characters.find(c => c.id == character_selector.value);

				const icon = character.icon;
				document.getElementById("character_icon").src = "data:image/png;base64," + icon;

				is_kansai.checked = character.dialect == "Kansai";

				document.getElementById("character_color").style.backgroundColor =
					character.background_color;
			};

			character_selector.addEventListener("change", update_character);

			fetch("/api/voices")
				.then(resp => resp.json())
				.then(characters_ => {
					characters = characters_;

					for (character of characters) {
						const option = document.createElement("option");
						option.textContent = character.name;
						option.value = character.id;
						character_selector.appendChild(option);
					}

					update_character();
					document.getElementById("character_count").textContent = characters.length;
				});

			document.getElementById("synthesis_button").addEventListener("click", async () => {
				const request_body = JSON.stringify({
					voice_id: character_selector.value,
					is_kansai: is_kansai.checked,
					text: text.value,
					volume: volume.value - 0,
					speed: speed.value - 0,
					pitch: pitch.value - 0,
					range: range.value - 0,
					pause_middle: pause_middle.value - 0,
					pause_long: pause_long.value - 0,
					pause_sentence: pause_sentence.value - 0,
				});

				const response = await fetch("/api/tts", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: request_body,
				});

				if (response.status != 200) {
					alert(response.status + " " + response.statusText + "\n" + await response.text());
					return;
				}

				const raw_wav = new Uint8Array(await response.arrayBuffer());
				const audio = document.getElementById("audio");
				audio.src = `data:audio/wav;base64,${raw_wav.toBase64()}`;
				audio.play();
			});
		</script>
	</div>
</body>
</html>
